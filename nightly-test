#!/bin/sh
# Usage: nightly-test <GMPDIR> <BRANCH>
set -e
GMP="$1"
BRANCH="$2"
DIR=mpfr-nightly
echo "BRANCH=$BRANCH"
echo "GMP=$GMP"
cd /tmp
/bin/rm -fr "$DIR"
mkdir "$DIR"
# The following test should be useless, but let's be paranoid.
test ! -h "$DIR"
svn checkout "svn://scm.gforge.inria.fr/svn/mpfr/${BRANCH:-trunk}" "$DIR"
cd "$DIR"
autoreconf -i
./configure --with-gmp="$GMP" --disable-alloca --enable-assert=full \
  --disable-shared --enable-thread-safe --enable-tests-timeout=60
make
export GMP_CHECK_RANDOMIZE=1
# disabled because --enable-tests-timeout does not seem to work
# export MPFR_CHECK_TINY=1
make check
cd /tmp
/bin/rm -fr "$DIR"
