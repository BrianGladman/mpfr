#!/bin/sh

echo This script will ask you several questions related to the configuration
echo of your system. To choose the default answer \(the one printed between
echo the brackets\), simply press Enter.
echo
echo "Checking echo to see how to suppress newlines..."

if (echo "hi\c"; echo " ") | grep c >/dev/null 2>&1 ; then
  echo "...using -n."; n=-n; c=
else
  cat <<EOM
...using \c
EOM
  n=; c='\c'
fi
echo $n ..."The star should be here-->$c"; echo '*'

if test -r config.in; then . config.in; fi

# TODO : gestion du echo -n...

# On determine OS et on met en place les flags bizarres.
syst=`uname -a | awk '{print $1$3}'`

case $syst in 
    SunOS5*)
        ostype=solaris	
	defC=/usr/local/bin/gcc
	machtype=sparc
	make=/usr/ccs/bin/make	
	;;
    Linux*)
	fpucw=`grep __setfpucw /usr/include/fpu_control.h`
	if test -z "$fpucw"; then special="-DLIBC211 $special"; fi;  # for __setfpucw
        ostype=linux
	defC=/usr/bin/gcc
	make=/usr/bin/make
	machtype=`uname -a | awk '{print $11}'`
	;;
    OSF*)
        special="-D__STDC__ $special -mfp-rounding-mode=d -mieee-with-inexact";
        ostype=alpha
	defC=/usr/local/bin/gcc
	make=/usr/local/gnu/bin/make # pour $LDLIBS des tests
	machtype=dec
	;;
    SunOS4*)
        ostype=sunos
	machtype=sparc
	defC=/usr/local/gnu/bin/gcc 
	make=/usr/local/gnu/bin/make
# Si on veut utiliser cc, faire gaffe aux prototypes a la K&R et pas ANSI.
	;;
    *)
	ostype=unknown
	make=/usr/local/gnu/bin/make
	machtype=default;;	
	# we should try to look for gcc there 
esac

echo You seem to be using a $machtype running $ostype.
echo

while :; do
    echo $n "Which C compiler are you going to use [$defC] ? $c"
    read ans
    case "$ans" in 
	'')
	ans="$defC"
	break
	;;
	*)
	if test -x "$ans"; then break; fi
	echo $n "*** $ans: file does not exist or execution permission denied"
    esac
done
defC=$ans

echo Using compiler $defC
echo
echo I now need to know where to find the GMP distribution. I do not actually
echo need the full distribution, but only the following include files : 
echo gmp.h, gmp-impl.h, gmp-mparam.h, longlong.h, stack-alloc.h

while :; do
    echo $n "Where should I look for these files [$inc] ? $c"
    read ans
    case "$ans" in 
	'')
	ans=$inc
	;;
	*) 
	;;
    esac
    if test -r "$ans"/gmp.h -a -r "$ans"/gmp-impl.h -a -r "$ans"/gmp-mparam.h -a -r "$ans"/longlong.h -a -r "$ans"/stack-alloc.h; 
    then incflags="-I$ans" 
	 break; 
    fi; 
    # ad hoc installation 
    
    if test -r "$ans"/gmp.h -a \
	    -r "$ans"/gmp-impl.h -a \
	    -r "$ans"/mpn/gmp-mparam.h -a \
	    -r "$ans"/longlong.h -a \
	    -r stack-alloc.h; 
    then 
    incflags="-I$ans -I$ans/mpn " 
    break; 
    fi; # gmp distrib 

    echo I could not find some of the files at that place, or could not read
    echo some of them. Please try again.
    echo 
done
inc=$ans

echo
echo If you wish to compile a program with the mpfr library, you will need
echo the gmp library. In particular, in order to compile the tests, you will
echo need it. Could you tell me where to find it ? 
echo $n "(You can lie, I won't check) path for the libgmp.a file [$lib] ? $c"
read ans

if test -z "$ans"; then ans=$lib; fi; 
if test -d "$ans" -a -r "$ans/libgmp.a"; then lib="$ans/libgmp.a"; fi; 
olib=$ans

echo
echo Unless you know what you are doing, you should not override the defaults
echo for the following.
echo $n "Flags for floating point rounding modes [$special] ? $c"
read ans
case "$ans" in 
	'')
	ans="$special"
	;;
	*) 
	;;
esac
special=$ans

if test -z "$cflags"; then cflags="-ansi -Wall -pedantic"; fi; 

echo
echo $n "What supplementary (optimization/debugging) flags are you willing to use [$cflags] ? $c"
read ans
case "$ans" in 
	'')
	ans="$cflags"
	;;
	*) 
	;;
esac
cflags=$ans

echo
echo Now dumping the Makefile. 

cat > config.in<<EOF
special="$special"
inc=$inc
lib=$olib
cflags="$cflags"
EOF

cat > Makefile <<EOF
#
# Makefile automatically generated by Configure. Do not edit !!
#
CC=$defC
CFLAGS=$special $incflags $cflags -D$ostype
OBJS=add.o div_2exp.o neg.o set_dfl_prec.o set_str_raw.o agm.o get_str.o print_raw.o set_dfl_rnd.o sqrt.o clear.o init.o rnd_mode.o set_f.o sub.o cmp.o mul.o  round.o set_prec.o cmp_ui.o mul_2exp.o set.o set_si.o div.o mul_ui.o set_d.o set_str.o pow.o out_str.o pi.o set_z.o add_ulp.o log2.o random.o log.o exp.o div_ui.o

dft: libmpfr.a

all: libmpfr.a tests

clean:
	-rm libmpfr.a \$(OBJS) config.in

libmpfr.a: \$(OBJS)
	ar cr libmpfr.a \$(OBJS)
	ranlib libmpfr.a    

tests: mpfr.h libmpfr.a
	-cd tests; $make all

add.o: mpfr.h
div_2exp.o: mpfr.h
neg.o: mpfr.h
set_dfl_prec.o: mpfr.h
set_str_raw.o: mpfr.h
agm.o: mpfr.h
get_str.o: mpfr.h
print_raw.o: mpfr.h
set_dfl_rnd.o: mpfr.h
sqrt.o: mpfr.h
clear.o: mpfr.h
init.o: mpfr.h
rnd_mode.o: mpfr.h
set_f.o: mpfr.h
sub.o: mpfr.h
cmp.o: mpfr.h
mul.o: mpfr.h
random.o: mpfr.h
round.o: mpfr.h
set_prec.o: mpfr.h
cmp_ui.o: mpfr.h
mul_2exp.o: mpfr.h
set.o: mpfr.h
set_si.o: mpfr.h
div.o: mpfr.h
mul_ui.o: mpfr.h
set_d.o: mpfr.h
set_str.o: mpfr.h
pow.o: mpfr.h
out_str.o: mpfr.h
pi.o: mpfr.h
set_z.o: mpfr.h
add_ulp.o: mpfr.h
log2.o: mpfr.h
log.o: mpfr.h
exp.o: mpfr.h
div_ui.o: mpfr.h

EOF
cat > tests/Makefile <<EOF
CC=$defC
CFLAGS=$special $incflags -I.. $cflags -D$ostype
LDLIBS=../libmpfr.a $lib -lm
TESTS=tadd tcmp2 tget_str tmul_ui tset_f tsqrt tagm tcmp_ui tmul tround tset_si tcmp tdiv tmul_2exp tset_d tset_str tpi tset_z tlog2 tcan_round tlog texp tdiv_ui

tests all: \$(TESTS)
	for i in \$(TESTS); do \
	echo Testing \$\$i; \
	./\$\$i; \
	done

clean:
	-rm \$(TESTS)

EOF




